<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>listening-with server test</title>
  <style>
    body {
      font-family: monospace;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    h1, h2 { color: #4a9eff; }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .panel {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #3a3a3a;
    }
    button {
      background: #4a9eff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-family: monospace;
    }
    button:hover { background: #3a7edf; }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      background: #1a1a1a;
      border: 1px solid #3a3a3a;
      color: #e0e0e0;
      border-radius: 4px;
      font-family: monospace;
    }
    #log {
      background: #0a0a0a;
      border: 1px solid #3a3a3a;
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      font-size: 12px;
      border-radius: 4px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #4a9eff;
      padding-left: 10px;
    }
    .log-sent { border-left-color: #ff9800; }
    .log-received { border-left-color: #4caf50; }
    .log-error { border-left-color: #f44336; }
    .qr-code {
      max-width: 200px;
      margin: 10px 0;
      background: white;
      padding: 10px;
      border-radius: 4px;
    }
    .room-info {
      background: #1a1a1a;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #4a9eff;
    }
    .search-result {
      background: #1a1a1a;
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      border: 1px solid #3a3a3a;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .search-result img {
      width: 60px;
      height: 60px;
      border-radius: 4px;
    }
    .search-result-info { flex: 1; }
    .status {
      padding: 5px 10px;
      border-radius: 4px;
      display: inline-block;
      margin: 10px 0;
    }
    .status-connected { background: #4caf50; color: white; }
    .status-disconnected { background: #f44336; color: white; }
  </style>
</head>
<body>
  <h1>listening-with server test</h1>

  <div class="status" id="status">disconnected</div>

  <div class="container">
    <div class="panel">
      <h2>connection</h2>
      <input type="text" id="serverUrl" value="ws://localhost:2946/ws" placeholder="server url">
      <button onclick="connect()" id="connectBtn">connect</button>
      <button onclick="disconnect()" id="disconnectBtn" disabled>disconnect</button>

      <h2>host actions</h2>
      <button onclick="createRoom()" id="createRoomBtn" disabled>create room</button>

      <div id="roomInfo"></div>

      <h2>client actions</h2>
      <input type="text" id="roomCode" placeholder="room code (e.g., WXYZ)">
      <input type="text" id="displayName" placeholder="display name - optional">
      <button onclick="joinRoom()" id="joinRoomBtn" disabled>join room</button>

      <h2>song search</h2>
      <input type="text" id="searchQuery" placeholder="search query">
      <button onclick="searchSongs()" id="searchBtn" disabled>search</button>

      <div id="searchResults"></div>

      <h2>utilities</h2>
      <button onclick="sendHeartbeat()" id="heartbeatBtn" disabled>send heartbeat</button>
      <button onclick="clearLog()">clear log</button>
    </div>

    <div class="panel">
      <h2>log</h2>
      <div id="log"></div>
    </div>
  </div>

  <script>
    let ws = null;
    let currentRoom = null;
    let searchResultsData = [];

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus(connected) {
      const status = document.getElementById('status');
      status.textContent = connected ? 'connected' : 'disconnected';
      status.className = connected ? 'status status-connected' : 'status status-disconnected';

      document.getElementById('connectBtn').disabled = connected;
      document.getElementById('disconnectBtn').disabled = !connected;
      document.getElementById('createRoomBtn').disabled = !connected;
      document.getElementById('joinRoomBtn').disabled = !connected;
      document.getElementById('searchBtn').disabled = !connected;
      document.getElementById('heartbeatBtn').disabled = !connected;
    }

    function connect() {
      const url = document.getElementById('serverUrl').value;
      log(`connecting to ${url}...`, 'info');

      ws = new WebSocket(url);

      ws.onopen = () => {
        log('connected to server', 'info');
        updateStatus(true);
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        log(`⬅ received: <pre>${JSON.stringify(data, null, 2)}</pre>`, 'received');
        handleMessage(data);
      };

      ws.onerror = (error) => {
        log(`error: ${error.message || 'connection failed'}`, 'error');
      };

      ws.onclose = () => {
        log('disconnected from server', 'info');
        updateStatus(false);
        ws = null;
      };
    }

    function disconnect() {
      if (ws) {
        ws.close();
      }
    }

    function send(message) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('not connected', 'error');
        return;
      }

      const json = JSON.stringify(message);
      ws.send(json);
      log(`➡ sent: <pre>${JSON.stringify(message, null, 2)}</pre>`, 'sent');
    }

    function createRoom() {
      send({ type: 'create_room' });
    }

    function joinRoom() {
      const roomCode = document.getElementById('roomCode').value;
      const displayName = document.getElementById('displayName').value;

      if (!roomCode) {
        log('room code required', 'error');
        return;
      }

      const message = {
        type: 'join_room',
        roomCode: roomCode.toUpperCase(),
      };

      if (displayName) {
        message.displayName = displayName;
      }

      send(message);
    }

    function searchSongs() {
      const query = document.getElementById('searchQuery').value;

      if (!query) {
        log('search query required', 'error');
        return;
      }

      send({ type: 'search_songs', query });
    }

    function addSong(index) {
      const song = searchResultsData[index];
      if (!song) return;

      const displayName = document.getElementById('displayName').value;

      const message = {
        type: 'add_song',
        videoId: song.videoId,
        title: song.title,
        artist: song.artist,
      };

      if (displayName) {
        message.submittedBy = displayName;
      }

      send(message);
    }

    function sendHeartbeat() {
      send({ type: 'heartbeat' });
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    function handleMessage(data) {
      switch (data.type) {
        case 'room_created':
          currentRoom = data;
          displayRoomInfo(data);
          break;

        case 'room_joined':
          log(`joined room ${data.roomCode}`, 'info');
          break;

        case 'search_results':
          searchResultsData = data.results;
          displaySearchResults(data.results);
          break;

        case 'song_added_success':
          log('song added to queue!', 'info');
          break;

        case 'client_joined':
          log(`client joined: ${data.displayName || 'anonymous'} (total: ${data.clientCount})`, 'info');
          break;

        case 'client_left':
          log(`client left (total: ${data.clientCount})`, 'info');
          break;

        case 'song_added':
          log(`song added to queue: ${data.song.title} by ${data.song.artist}`, 'info');
          break;

        case 'room_closed':
          log(`room closed: ${data.reason}`, 'error');
          currentRoom = null;
          document.getElementById('roomInfo').innerHTML = '';
          break;

        case 'error':
          log(`error: ${data.message}`, 'error');
          break;

        case 'heartbeat_ack':
          log('heartbeat acknowledged', 'info');
          break;
      }
    }

    function displayRoomInfo(data) {
      const roomInfoDiv = document.getElementById('roomInfo');
      roomInfoDiv.innerHTML = `
        <div class="room-info">
          <h3>room created!</h3>
          <p><strong>code:</strong> ${data.code}</p>
          <p><strong>qr code:</strong></p>
          <img src="${data.qrCodeDataUrl}" class="qr-code" alt="qr code">
        </div>
      `;
    }

    function displaySearchResults(results) {
      const resultsDiv = document.getElementById('searchResults');

      if (results.length === 0) {
        resultsDiv.innerHTML = '<p>no results found</p>';
        return;
      }

      resultsDiv.innerHTML = `<h3>results (${results.length})</h3>`;

      results.forEach((result, index) => {
        const div = document.createElement('div');
        div.className = 'search-result';
        div.innerHTML = `
          ${result.thumbnailUrl ? `<img src="${result.thumbnailUrl}" alt="${result.title}">` : ''}
          <div class="search-result-info">
            <div><strong>${result.title}</strong></div>
            <div>${result.artist}</div>
            ${result.duration ? `<div>${result.duration}</div>` : ''}
          </div>
          <button onclick="addSong(${index})">add to queue</button>
        `;
        resultsDiv.appendChild(div);
      });
    }
  </script>
</body>
</html>
